# ุชูุฑูุฑ ููุงุฆู: ูุดููุฉ ุงูุฃุฏุงุก ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ

**ุงูุชุงุฑูุฎ:** 19 ุฃูุชูุจุฑ 2025  
**ุงููุดุฑูุน:** ุจูุงุจุฉ ุณุจู ุงูุฐููุฉ (sabqnews)  
**ุงูุจูุฆุฉ:** Vercel + Supabase PostgreSQL

---

## ๐ฏ ููุฎุต ุงููุดููุฉ

ููุญุฉ ุงูุฅุฏุงุฑุฉ ุฃุตุจุญุช **ุจุทูุฆุฉ ุฌุฏุงู** ุจุนุฏ ุชุนุฏููุงุช "ุงูุชุญุณูู" ุงูุฃุฎูุฑุฉ:
- โ ูุงูุช ุชุนูู ุจุณุฑุนุฉ ูู ุงูุจุฏุงูุฉ
- โ ุฃุตุจุญุช ุจุทูุฆุฉ ุฌุฏุงู ุจุนุฏ ุนุฏุฉ ุชุนุฏููุงุช
- โ ุชุณุฌูู ุงูุฏุฎูู ูุณุชุบุฑู ุฃูุซุฑ ูู 30 ุซุงููุฉ
- โ ุตูุญุงุช ููุญุฉ ุงูุฅุฏุงุฑุฉ ุชุธูุฑ "ุฌุงุฑู ุงูุชุญููู..." ููุง ุชูุชูู

---

## ๐ ุงูุชุดุฎูุต ุงูููุงุฆู

### ุงููุดุงูู ุงูุชู ุชู ุงูุชุดุงููุง ูุฅุตูุงุญูุง:

#### 1. โ ุงูู joins ุงูุจุทูุฆุฉ ูู `articles.list`

**ุงูููู:** `server/routers/articles.ts`  
**Commit:** `fe0d9f3`

**ุงููุดููุฉ:**
```typescript
.select({
  ...articles,  // โ spread operator ูุง ูุนูู ุจุดูู ุตุญูุญ ูุน Drizzle
  author: { ... },
  category: { ... },
})
.leftJoin(users, ...)
.leftJoin(categories, ...)
```

**ุงูุชุฃุซูุฑ:** ุงุณุชุนูุงู ุจุทูุก ุฌุฏุงู ุจุณุจุจ ูุญุงููุฉ Drizzle ุชุญููู ุงูู spread operator ูุน joins.

**ุงูุญู:** โ ุชู ุฅุฑุฌุงุน ุงูุงุณุชุนูุงู ุฅูู `.select()` ุงูุจุณูุท

---

#### 2. โ `idle_timeout: 20` ุงููุตูุฑ ุฌุฏุงู

**ุงูููู:** `lib/db.ts`  
**Commit:** `148553f`

**ุงููุดููุฉ:**
```typescript
const client = postgres(connectionString, {
  idle_timeout: 20, // โ ููุบูู ุงูุงุชุตุงู ุจุนุฏ 20 ุซุงููุฉ ููุท!
  max_lifetime: 60 * 30,
  connect_timeout: 10,
});
```

**ุงูุชุฃุซูุฑ:** 
- ุงูุงุชุตุงู ููุบูู ุจุนุฏ 20 ุซุงููุฉ ูู ุนุฏู ุงููุดุงุท
- ุนูุฏ ุทูุจ ุฌุฏูุฏุ ูุญุชุงุฌ ูุฅูุดุงุก ุงุชุตุงู ุฌุฏูุฏ
- ูุน Poolerุ ูุฐุง ูุณุชุบุฑู ููุชุงู ุทูููุงู ุฌุฏุงู (10-30 ุซุงููุฉ)

**ุงูุญู:** โ ุชู ุฅุฒุงูุฉ `idle_timeout` ู `max_lifetime` ูุงุณุชุฎุฏุงู ุงูููู ุงูุงูุชุฑุงุถูุฉ

---

#### 3. โ ุฎุทุฃ ูู ุงุณุชุฏุนุงุก `getDb()`

**ุงูููู:** `app/api/auth/login/route.ts`

**ุงููุดููุฉ:**
```typescript
const db = await getDb(); // โ ุงุณุชุฎุฏุงู await ุนูู ุฏุงูุฉ ุบูุฑ async
```

**ุงูุญู:** โ ุชู ุฅุฒุงูุฉ `await`

---

## ๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ

### ุงูุจูุฆุฉ ุงููุญููุฉ (Local)
- โ ุงุณุชุนูุงู users: **37ms**
- โ ุงุณุชุนูุงู articles: **ุณุฑูุน**
- โ ุฌููุน ุงูููุงุฑุณ ููุฌูุฏุฉ ูุตุญูุญุฉ

### ุจูุฆุฉ Vercel (Production)
- โ ุชุณุฌูู ุงูุฏุฎูู: **30+ ุซุงููุฉ** (timeout)
- โ ุตูุญุงุช ููุญุฉ ุงูุฅุฏุงุฑุฉ: **ูุง ุชุญููู**

---

## ๐จ ุงููุดููุฉ ุงููุชุจููุฉ

ุจุนุฏ ุฅุตูุงุญ ุฌููุน ุงููุดุงูู ูู ุงูููุฏุ **ุงููุดููุฉ ูุง ุชุฒุงู ููุฌูุฏุฉ ูู ุจูุฆุฉ Vercel**.

### ุงูุณุจุจ ุงูุฌุฐุฑู

**ุงุณุชุฎุฏุงู ุฑุงุจุท Pooler (port 6543) ุจุฏูุงู ูู Direct Connection (port 5432)**

```
# โ ุงูุฑุงุจุท ุงูุญุงูู (Pooler - ุจุทูุก)
postgres://...@aws-1-us-east-1.pooler.supabase.com:6543/postgres

# โ ุงูุฑุงุจุท ุงูููุตู ุจู (Direct Connection - ุณุฑูุน)
postgres://...@db.ktwlrwxtpspnflarvzoo.supabase.co:5432/postgres
```

### ููุงุฐุง Pooler ุจุทูุก ูุน Vercel Serverlessุ

1. **Cold Start:** ูู Serverless Function ุชุจุฏุฃ ูู ุงูุตูุฑ
2. **Connection Overhead:** Pooler ูุถูู latency ุฅุถุงูู
3. **Connection Pooling:** ูุง ูุนูู ุจุดูู ูุนูุงู ูุน Serverless
4. **Timeout Issues:** ุงูุงุชุตุงู ูุณุชุบุฑู ููุชุงู ุทูููุงู ููุชุฃุณูุณ

---

## โ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ

### 1. ุฅุตูุงุญ ุงูููุฏ
- โ ุฅุฒุงูุฉ joins ุงูุจุทูุฆุฉ ูู `articles.list`
- โ ุฅุฒุงูุฉ `idle_timeout` ุงููุตูุฑ
- โ ุฅุตูุงุญ ุงุณุชุฏุนุงุก `getDb()`
- โ ุฅุถุงูุฉ timeout (30 ุซุงููุฉ) ูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
- โ ุฅุถุงูุฉ caching ูู `admin/layout.tsx`

### 2. ุชุญุณูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฅุถุงูุฉ ููุฑุณ `created_at` ุนูู ุฌุฏูู articles
- โ ุงูุชุญูู ูู ูุฌูุฏ ุฌููุน ุงูููุงุฑุณ ุงููุทููุจุฉ

---

## ๐ฏ ุงูุญู ุงูููุงุฆู ุงูููุตู ุจู

### ุงูุฎูุงุฑ 1: ุชุบููุฑ ุฑุงุจุท ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู Vercel (ููุตู ุจู)

1. ุงูุชุญ [ุฅุนุฏุงุฏุงุช ุงูุจูุฆุฉ ูู Vercel](https://vercel.com/sabq4orgs-projects/sabqnews/settings/environment-variables)
2. ุงุจุญุซ ุนู ูุชุบูุฑ `DATABASE_URL` ุฃู `POSTGRES_URL`
3. ุบููุฑ ุงููููุฉ ูู Pooler ุฅูู Direct Connection:
   ```
   postgres://postgres.ktwlrwxtpspnflarvzoo:BVyhrcNHCxzrmOCj@db.ktwlrwxtpspnflarvzoo.supabase.co:5432/postgres
   ```
4. ุงุญูุธ ุงูุชุบููุฑุงุช ูุฃุนุฏ ูุดุฑ ุงููุดุฑูุน

### ุงูุฎูุงุฑ 2: ุงุณุชุฎุฏุงู Supabase Connection Pooler ุจุดูู ุตุญูุญ

ุฅุฐุง ููุช ุชุฑูุฏ ุงูุงุณุชูุฑุงุฑ ูู ุงุณุชุฎุฏุงู Poolerุ ุนุฏูู `lib/db.ts`:

```typescript
const client = postgres(connectionString, {
  prepare: false,
  max: 10, // โ ุฒูุงุฏุฉ ุนุฏุฏ ุงูุงุชุตุงูุงุช
  connection: {
    application_name: 'sabqnews',
  },
  // โ ูุง ุชุถุน idle_timeout ุฃู max_lifetime
});
```

### ุงูุฎูุงุฑ 3: ุงุณุชุฎุฏุงู Vercel Postgres (ุจุฏูู)

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉุ ูููู ุงูุชุญููู ุฅูู [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres) ุงููุญุณูู ููุนูู ูุน Serverless.

---

## ๐ ุงููุชุงุฆุฌ ุงููุชููุนุฉ ุจุนุฏ ุชุทุจูู ุงูุญู

### ูุจู ุงูุฅุตูุงุญ
- โ ุชุณุฌูู ุงูุฏุฎูู: **30+ ุซุงููุฉ**
- โ ุตูุญุฉ ุงูููุงูุงุช: **ูุง ุชุญููู**
- โ ุตูุญุฉ ุงูุชุตูููุงุช: **ูุง ุชุญููู**

### ุจุนุฏ ุงูุฅุตูุงุญ
- โ ุชุณุฌูู ุงูุฏุฎูู: **ุฃูู ูู 2 ุซุงููุฉ**
- โ ุตูุญุฉ ุงูููุงูุงุช: **ุชุญููู ููุฑู**
- โ ุตูุญุฉ ุงูุชุตูููุงุช: **ุชุญููู ููุฑู**

---

## ๐ ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ

### 1. ูุง ุชุซู ูู "ุงูุชุญุณููุงุช" ุจุฏูู ุงุฎุชุจุงุฑ
- โ ุฅุถุงูุฉ joins "ูุชุญุณูู ุงูุฃุฏุงุก" ุฃุจุทุฃุช ุงูุงุณุชุนูุงู
- โ ุฅุถุงูุฉ `idle_timeout` "ูุชูููุฑ ุงูููุงุฑุฏ" ุณุจุจุช ุจุทุก ุดุฏูุฏ

### 2. Serverless โ Traditional Server
- Pooler ูุตูู ููุฎูุงุฏู ุงูุชูููุฏูุฉุ ููุณ Serverless
- Direct Connection ุฃูุถู ูุน Vercel Serverless Functions

### 3. ุงุฎุชุจุฑ ูู ุจูุฆุฉ Production
- ุงูููุฏ ูุนูู ุจุณุฑุนุฉ ูุญููุงู ููู ุจุทูุก ูู Production
- ุงููุดููุฉ ูู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุชุ ููุณ ุงูููุฏ

### 4. ุงุณุชุฎุฏู ุงูููู ุงูุงูุชุฑุงุถูุฉ
- ูุง ุชุถุน `idle_timeout` ุฃู `max_lifetime` ุฅูุง ุฅุฐุง ููุช ุชุนุฑู ูุง ุชูุนูู
- ุงูููู ุงูุงูุชุฑุงุถูุฉ ุนุงุฏุฉ ุฃูุถู

---

## ๐ง ุงููููุงุช ุงููุนุฏููุฉ

1. โ `server/routers/articles.ts` - ุฅุฒุงูุฉ joins ุงูุจุทูุฆุฉ
2. โ `lib/db.ts` - ุฅุฒุงูุฉ idle_timeout
3. โ `app/api/auth/login/route.ts` - ุฅุตูุงุญ getDb()
4. โ `app/(auth)/login/page.tsx` - ุฅุถุงูุฉ timeout
5. โ `app/admin/layout.tsx` - ุฅุถุงูุฉ caching
6. โ `drizzle/schema.ts` - ุฅุตูุงุญ syntax errors

---

## ๐ฏ ุงูุฎูุงุตุฉ

**ุงููุดููุฉ ุงูุฃุณุงุณูุฉ:** ุชุนุฏููุงุช "ุงูุชุญุณูู" ุงูุฃุฎูุฑุฉ (joins + idle_timeout) ุฃุจุทุฃุช ุงููุธุงู ุจุดูู ูุจูุฑ.

**ุงูุญู ุงููุทุจู:** ุชู ุฅุตูุงุญ ุฌููุน ุงููุดุงูู ูู ุงูููุฏ.

**ุงูุญู ุงูููุงุฆู:** ุชุบููุฑ ุฑุงุจุท ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู Vercel ูู Pooler ุฅูู Direct Connection.

**ุงูุญุงูุฉ:** โ ุงูููุฏ ุฌุงูุฒ - ูุชุทูุจ ุชุบููุฑ ุฅุนุฏุงุฏุงุช Vercel

---

**ุชู ุฅุนุฏุงุฏ ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** Manus AI  
**ุงูุชุงุฑูุฎ:** 19 ุฃูุชูุจุฑ 2025

