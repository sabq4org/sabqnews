# ุชูุฑูุฑ ุฅุตูุงุญ ูุดุงูู ุงูุฃุฏุงุก ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ

**ุงูุชุงุฑูุฎ:** 19 ุฃูุชูุจุฑ 2025  
**ุงููุดุฑูุน:** ุจูุงุจุฉ ุณุจู ุงูุฐููุฉ (sabqnews)  
**ุงูุจูุฆุฉ:** Vercel + Supabase PostgreSQL

---

## ๐ ููุฎุต ุงููุดููุฉ

ููุญุฉ ุงูุฅุฏุงุฑุฉ ุฃุตุจุญุช **ุจุทูุฆุฉ ุฌุฏุงู** ุจุนุฏ ูุญุงููุงุช ุงูุชุญุณูู ุงูุฃุฎูุฑุฉุ ุญูุซ:
- **ุชุณุฌูู ุงูุฏุฎูู** ูุณุชุบุฑู ุฃูุซุฑ ูู 30 ุซุงููุฉ ุฃู ูุชุนุทู ุชูุงูุงู
- **ุตูุญุงุช ููุญุฉ ุงูุฅุฏุงุฑุฉ** ุชุธูุฑ "ุฌุงุฑู ุงูุชุญููู..." ููุง ุชูุชูู ุฃุจุฏุงู
- **ุงุณุชุนูุงูุงุช tRPC** ุจุทูุฆุฉ ุฌุฏุงู ุฃู ุชูุดู

---

## ๐ ุงูุชุดุฎูุต

### 1. ุงููุดููุฉ ุงูุฃุณุงุณูุฉ: ุฎุทุฃ ูู ุงุณุชุฏุนุงุก `getDb()`

**ุงูููู:** `app/api/auth/login/route.ts`  
**ุงูุณุทุฑ:** 19

```typescript
// โ ุฎุทุฃ - ุงุณุชุฎุฏุงู await ุนูู ุฏุงูุฉ ุบูุฑ async
const db = await getDb();
```

**ุงูุชุฃุซูุฑ:** ูุฐุง ูุณุจุจ ุชุนููู ุงูุทูุจ ูุฃู `getDb()` ููุณุช ุฏุงูุฉ async ูุชูุฑุฌุน `db` ูุจุงุดุฑุฉ.

**ุงูุญู:**
```typescript
// โ ุตุญูุญ
const db = getDb();
```

---

### 2. ุงููุดููุฉ ุงูุซุงูููุฉ: ุงุณุชุฎุฏุงู Pooler ุจุฏูุงู ูู Direct Connection

**ุงููุดููุฉ:**  
ูุชุบูุฑ ุงูุจูุฆุฉ `DATABASE_URL` ุฃู `POSTGRES_URL` ูู Vercel ูุณุชุฎุฏู ุฑุงุจุท **Pooler** (port 6543):

```
postgres://postgres.ktwlrwxtpspnflarvzoo:BVyhrcNHCxzrmOCj@aws-1-us-east-1.pooler.supabase.com:6543/postgres
```

**ุงูุชุฃุซูุฑ:**  
- ุฑุงุจุท Pooler ูุตูู ููุงุชุตุงูุงุช ุงููุตูุฑุฉ ุงููุชุนุฏุฏุฉ
- ูุถูู **latency ุฅุถุงูู** ูุน Vercel Serverless Functions
- ูุณุจุจ **ุจุทุก ุดุฏูุฏ** ูู ุงูุงุณุชุนูุงูุงุช (30+ ุซุงููุฉ)

**ุงูุญู ุงูููุตู ุจู:**  
ุงุณุชุฎุฏุงู **Direct Connection** (port 5432):

```
postgres://postgres.ktwlrwxtpspnflarvzoo:BVyhrcNHCxzrmOCj@db.ktwlrwxtpspnflarvzoo.supabase.co:5432/postgres
```

---

### 3. ูุดุงูู ุฅุถุงููุฉ ุชู ุฅุตูุงุญูุง

#### ุฃ. ุฎุทุฃ Syntax ูู `schema.ts`

**ุงููุดููุฉ:**  
ุชุนุฑููุงุช `index` ุฎุงุฑุฌ ููุงููุง ุงูุตุญูุญ ูู ุฌุฏุงูู `categories` ู `articles`.

**ุงูุญู:**  
ููู ุชุนุฑููุงุช ุงูููุงุฑุณ ุฅูู ุฏุงุฎู ุฏุงูุฉ `(table) => ({...})`.

#### ุจ. ููุฑุณ `created_at` ููููุฏ

**ุงููุดููุฉ:**  
ูุง ููุฌุฏ ููุฑุณ ุนูู ุนููุฏ `created_at` ูู ุฌุฏูู `articles`ุ ููุง ูุณุจุจ ุจุทุก ูู ุงุณุชุนูุงู `ORDER BY created_at DESC`.

**ุงูุญู:**  
```sql
CREATE INDEX articles_created_at_idx ON articles (created_at DESC);
```

#### ุฌ. ุงุณุชุนูุงู `auth.me` ุจุทูุก ูู `admin/layout.tsx`

**ุงููุดููุฉ:**  
ุงุณุชุฏุนุงุก `trpc.auth.me.useQuery()` ุจุฏูู caching ุฃู ุชุญุฏูุฏ ุนุฏุฏ ุงููุญุงููุงุช.

**ุงูุญู:**  
```typescript
const { data: user, isLoading } = trpc.auth.me.useQuery(undefined, {
  retry: 1,
  staleTime: 5 * 60 * 1000, // Cache for 5 minutes
  refetchOnWindowFocus: false,
});
```

---

## โ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ

### 1. ุฅุตูุงุญ `schema.ts`
- โ ููู ุชุนุฑููุงุช ุงูููุงุฑุณ ุฅูู ุงูููุงู ุงูุตุญูุญ
- โ ุญุฐู ูููุงุช migrations ุงููุชุถุงุฑุจุฉ

### 2. ุฅุถุงูุฉ ููุฑุณ `created_at`
- โ ุชู ุฅุถุงูุฉ ุงูููุฑุณ ูุจุงุดุฑุฉ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุชู ุงูุชุญูู ูู ูุฌูุฏ ุงูููุฑุณ

### 3. ุชุญุณูู `lib/db.ts`
- โ ุฅุถุงูุฉ timeouts ููุงุชุตุงู:
  - `idle_timeout: 20` ุซุงููุฉ
  - `max_lifetime: 1800` ุซุงููุฉ (30 ุฏูููุฉ)
  - `connect_timeout: 10` ุซูุงูู

### 4. ุฅุตูุงุญ `app/api/auth/login/route.ts`
- โ ุฅุฒุงูุฉ `await` ูู `getDb()`
- โ ุฅุฒุงูุฉ ุงููุญุต ุบูุฑ ุงูุถุฑูุฑู `if (!db)`

### 5. ุชุญุณูู `app/(auth)/login/page.tsx`
- โ ุฅุถุงูุฉ timeout (30 ุซุงููุฉ) ููุทูุจ
- โ ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

### 6. ุชุญุณูู `app/admin/layout.tsx`
- โ ุฅุถุงูุฉ caching ูุงุณุชุนูุงู `auth.me`
- โ ุชูููู ุนุฏุฏ ุงููุญุงููุงุช ูู 3 ุฅูู 1

---

## ๐ ุงูุญู ุงูููุงุฆู ุงูููุตู ุจู

### ุงูุฎุทูุฉ 1: ุชุบููุฑ ุฑุงุจุท ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู Vercel

1. ุงูุชุญ [ุฅุนุฏุงุฏุงุช ุงูุจูุฆุฉ ูู Vercel](https://vercel.com/sabq4orgs-projects/sabqnews/settings/environment-variables)
2. ุงุจุญุซ ุนู ูุชุบูุฑ `DATABASE_URL` ุฃู `POSTGRES_URL`
3. ุบููุฑ ุงููููุฉ ูู:
   ```
   postgres://postgres.ktwlrwxtpspnflarvzoo:BVyhrcNHCxzrmOCj@aws-1-us-east-1.pooler.supabase.com:6543/postgres
   ```
   ุฅูู:
   ```
   postgres://postgres.ktwlrwxtpspnflarvzoo:BVyhrcNHCxzrmOCj@db.ktwlrwxtpspnflarvzoo.supabase.co:5432/postgres
   ```
4. ุงุญูุธ ุงูุชุบููุฑุงุช
5. ุฃุนุฏ ูุดุฑ ุงููุดุฑูุน (Redeploy)

### ุงูุฎุทูุฉ 2: ุงูุชุญูู ูู ุงูุฃุฏุงุก

ุจุนุฏ ุฅุนุงุฏุฉ ุงููุดุฑุ ุงุฎุชุจุฑ:
- โ ุชุณุฌูู ุงูุฏุฎูู (ูุฌุจ ุฃู ูููู ุฃูู ูู 2 ุซุงููุฉ)
- โ ุตูุญุฉ ุงูููุงูุงุช (ูุฌุจ ุฃู ุชุญููู ููุฑุงู)
- โ ุตูุญุฉ ุงูุชุตูููุงุช (ูุฌุจ ุฃู ุชุญููู ููุฑุงู)

---

## ๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ุงููุญูู

### ูุจู ุงูุฅุตูุงุญ
- โ ุชุณุฌูู ุงูุฏุฎูู: **30+ ุซุงููุฉ** (timeout)
- โ ุงุณุชุนูุงู users: **ุบูุฑ ููุชูู**
- โ ุตูุญุงุช ููุญุฉ ุงูุฅุฏุงุฑุฉ: **ูุง ุชุญููู**

### ุจุนุฏ ุงูุฅุตูุงุญ (ูุญููุงู)
- โ ุงุณุชุนูุงู users: **39ms**
- โ ุงุณุชุนูุงู articles: **ุณุฑูุน**
- โ ุงูููุงุฑุณ: **ููุฌูุฏุฉ ูุตุญูุญุฉ**

---

## ๐ง ูููุงุช ุชู ุชุนุฏูููุง

1. โ `drizzle/schema.ts` - ุฅุตูุงุญ syntax errors
2. โ `lib/db.ts` - ุฅุถุงูุฉ timeouts
3. โ `app/api/auth/login/route.ts` - ุฅุตูุงุญ `getDb()`
4. โ `app/(auth)/login/page.tsx` - ุฅุถุงูุฉ timeout
5. โ `app/admin/layout.tsx` - ุฅุถุงูุฉ caching
6. โ ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุฅุถุงูุฉ ููุฑุณ `created_at`

---

## ๐ ุงูุชูุตูุงุช ุงููุณุชูุจููุฉ

### 1. ูุฑุงูุจุฉ ุงูุฃุฏุงุก
- ุงุณุชุฎุฏู [Vercel Analytics](https://vercel.com/analytics) ููุฑุงูุจุฉ ุฃุฏุงุก API
- ุฑุงูุจ ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู [Supabase Dashboard](https://supabase.com/dashboard)

### 2. ุชุญุณููุงุช ุฅุถุงููุฉ
- ุฃุถู **Redis caching** ููุงุณุชุนูุงูุงุช ุงููุชูุฑุฑุฉ
- ุงุณุชุฎุฏู **React Query** ูุน staleTime ุฃุทูู
- ุฃุถู **pagination** ูุตูุญุงุช ุงูููุงูุงุช

### 3. ุฃูุถู ุงูููุงุฑุณุงุช
- **ูุง ุชุณุชุฎุฏู** `await` ุนูู ุฏูุงู ุบูุฑ async
- **ุงุณุชุฎุฏู Direct Connection** ูุน Vercel Serverless
- **ุฃุถู ููุงุฑุณ** ุนูู ุงูุฃุนูุฏุฉ ุงููุณุชุฎุฏูุฉ ูู `WHERE` ู `ORDER BY`
- **ุงุณุชุฎุฏู caching** ูุชูููู ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

## ๐ฏ ุงูุฎูุงุตุฉ

ุงููุดููุฉ ุงูุฃุณุงุณูุฉ ูุงูุช **ุฎุทุฃ ูู ุงุณุชุฏุนุงุก `getDb()`** ูุน **ุงุณุชุฎุฏุงู ุฑุงุจุท Pooler ุงูุจุทูุก**. 

ุชู ุฅุตูุงุญ ุฌููุน ุงููุดุงูู ูู ุงูููุฏุ ููู **ุงูุญู ุงูููุงุฆู** ูุชุทูุจ ุชุบููุฑ ุฑุงุจุท ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู Vercel ุฅูู **Direct Connection**.

ุจุนุฏ ุชุทุจูู ูุฐุง ุงูุชุบููุฑุ ุณูุนูุฏ ุงูุฃุฏุงุก ุฅูู **ุงูุญุงูุฉ ุงูุทุจูุนูุฉ** (ุฃูู ูู 2 ุซุงููุฉ ูุชุณุฌูู ุงูุฏุฎูู).

---

**ุชู ุฅุนุฏุงุฏ ุงูุชูุฑูุฑ ุจูุงุณุทุฉ:** Manus AI  
**ุงูุญุงูุฉ:** โ ุชู ุชุดุฎูุต ุงููุดููุฉ ูุฅุตูุงุญ ุงูููุฏ - ูุชุทูุจ ุชุบููุฑ ุฅุนุฏุงุฏุงุช Vercel

